<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SVS Attendance</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background-color: white;
      min-height: 100vh;
    }

    .card {
      border-radius: 20px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      padding: 30px;
      margin-top: 50px;
      transition: transform 0.3s, box-shadow 0.3s;
      background: white;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 30px rgba(0,0,0,0.15);
    }

    h1 {
      font-weight: 700;
      margin-bottom: 10px;
      color: #343a40;
    }

    p.subtitle {
      font-size: 1rem;
      color: #6c757d;
      margin-bottom: 30px;
    }

    .btn-primary, .btn-secondary {
      border-radius: 50px;
      padding: 10px 25px;
      font-weight: 500;
      transition: all 0.3s;
    }

    .btn-primary {
      background: linear-gradient(90deg, #0062E6, #33AEFF);
      border: none;
      color: #fff;
    }

    .btn-primary:hover {
      background: linear-gradient(90deg, #0052cc, #0099ff);
    }

    .btn-secondary {
      background: #6c757d;
      border: none;
      color: #fff;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    #flashContainer .alert {
      margin-bottom: 10px;
    }
    #flashContainer .alert strong {
      margin-right: 5px;
    }

  .svs-logo {
    max-width: 3000px;
    width: 90%;       
    height: auto;  
  }

  @media (max-width: 576px) {
    .svs-logo {
      max-width: 3000px;
      width: 90%;
    }
  }

  @media (min-width: 577px) and (max-width: 992px) {
    .svs-logo {
      max-width: 3000px;
      width: 90%;
    }
  }
  footer {
      margin-top: auto;
      background: #f8f9fa;
      padding: 15px 0;
      text-align: center;
      font-size: 0.9rem;
      color: #6c757d;
      border-top: 1px solid #e9ecef;
    }
    footer a {
      color: #007bff;
      text-decoration: none;
    }
    footer .container {
      max-width: 960px;
      margin: 0 auto;
    }
  </style>
</head>

<body>
  <div class="container py-5">
    <div class="text-center mb-4">
      <img class="svs-logo" src="{{ url_for('static', filename='assets/svs.jpg') }}" alt="SVS">
    </div>

    <div class="text-center">
      <h1>Students Attendance</h1>
      <p class="subtitle">Select your Google Sheet to send SMS or preview</p>
    </div>

    <div class="row justify-content-center">
      <div class="col-md-6">
        <div class="card">

          <form id="smsForm" class="d-flex flex-column gap-3">
            <label for="sheetSelect" class="form-label fw-bold">Select Google Sheet</label>
            <select id="sheetSelect" name="sheet_id" class="form-select" required>
              {% for f in files %}
                <option value="{{ f.id }}">{{ f.name }}</option>
              {% endfor %}
            </select>

            <div class="d-flex justify-content-between gap-2 mt-3">
              <button type="button" id="previewBtn" class="btn btn-secondary">
                <i class="fas fa-eye me-1"></i> Preview
              </button>
              <button type="submit" id="sendBtn" class="btn btn-primary">
                <i class="fas fa-paper-plane me-1"></i> Send SMS
              </button>
            </div>
          </form>

          <div id="flashContainer" class="mt-4">
            {% with messages = get_flashed_messages() %}
              {% if messages %}
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <strong>Notifications:</strong>
                  <button id="clearAll" class="btn btn-sm btn-outline-danger">All Clear</button>
                </div>
                {% for msg in messages %}
                  <div class="alert alert-success mb-2" role="alert">
                    {{ msg }}
                  </div>
                {% endfor %}
              {% endif %}
            {% endwith %}
          </div>

          <div id="progressWrapper" class="mt-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <strong>Live progress:</strong>
              <small id="progressSummary" class="text-muted">Waiting to start</small>
            </div>
            <div id="progressLog" style="max-height:300px; overflow:auto; background:#f8f9fa; padding:10px; border-radius:8px; border:1px solid #e9ecef;">
              <!-- realtime messages will be appended here -->
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <footer>
    <div class="container">
      <p>&copy; 2025 SVS Attendance System | Built with <i class="fas fa-heart text-danger"></i> by <a href="https://phoenix-tech.onrender.com/">Phoenix</a></p>
    </div>
  </footer>
  <!-- scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Preview in same tab
    document.getElementById('previewBtn').addEventListener('click', function() {
      const sheetId = document.getElementById('sheetSelect').value;
      if (sheetId) {
        window.location.href = "{{ url_for('preview_sheet') }}?sheet_id=" + sheetId;
      }
    });

    // SSE sending logic
    document.getElementById('smsForm').addEventListener('submit', function(e) {
      e.preventDefault();

      const sheetId = document.getElementById('sheetSelect').value;
      if (!sheetId) return alert('Please select a sheet.');

      const progressLog = document.getElementById('progressLog');
      const progressSummary = document.getElementById('progressSummary');
      const sendBtn = document.getElementById('sendBtn');
      const previewBtn = document.getElementById('previewBtn');

      // disable buttons while sending
      sendBtn.disabled = true;
      previewBtn.disabled = true;
      progressLog.innerHTML = '';

      // open SSE connection
      const sse = new EventSource("/stream_send_sms?sheet_id=" + encodeURIComponent(sheetId));

      function appendLine(obj) {
        const line = document.createElement('div');
        let icon = '';
        if (obj.status === 'sent') icon = '‚úÖ';
        else if (obj.status === 'invalid' || obj.status === 'skipped') icon = '‚ö†Ô∏è';
        else if (obj.status === 'failed') icon = '‚ùå';
        else if (obj.status === 'done') icon = 'üèÅ';
        else if (obj.status === 'error') icon = 'üö´';

        const text = `${icon} ${obj.msg || ''}` + (obj.name ? ` ‚Äî ${obj.name}` : '') + (obj.phone ? ` (${obj.phone})` : '') + (obj.row ? ` [row ${obj.row}]` : '');
        line.textContent = text;
        progressLog.appendChild(line);
        progressLog.scrollTop = progressLog.scrollHeight;
      }

      sse.onmessage = function(e) {
        try {
          const data = JSON.parse(e.data);
          appendLine(data);
          // update compact summary
          if (data.status === 'sent' || data.status === 'failed') {
            // nothing special; summary is updated in 'done' event
            progressSummary.textContent = 'Sending...';
          } else if (data.status === 'invalid' || data.status === 'skipped') {
            progressSummary.textContent = 'Sending (with skips)...';
          } else if (data.status === 'error') {
            progressSummary.textContent = 'Stopped (error)';
          }
        } catch (err) {
          console.error('Invalid SSE data', e.data);
        }
      };

      // final completion event (we used 'event: done' on server)
      sse.addEventListener('done', function(e) {
        const data = JSON.parse(e.data);
        appendLine(data);
        progressSummary.textContent = `Completed ‚Äî ${data.sent_count ?? '0'} sent`;
        // close the connection
        sse.close();
        sendBtn.disabled = false;
        previewBtn.disabled = false;

        // Optionally show a flash-style block (temporary)
        const flashContainer = document.getElementById('flashContainer');
        if (flashContainer) {
          const alert = document.createElement('div');
          alert.className = 'alert alert-success mt-2';
          alert.textContent = `‚úÖ SMS sent to ${data.sent_count ?? 0} contacts!`;
          flashContainer.prepend(alert);
        }
      });

      // handle SSE errors (like server closed)
      sse.onerror = function(e) {
        console.error('SSE error', e);
        // show simple message and re-enable
        const errLine = {status:'error', msg:'Connection closed or error occurred.'};
        appendLine(errLine);
        progressSummary.textContent = 'Error';
        sse.close();
        sendBtn.disabled = false;
        previewBtn.disabled = false;
      };
    });

    // clear flashes locally
    const clearBtn = document.getElementById('clearAll');
    if (clearBtn){
      clearBtn.addEventListener('click', function() {
        const flashContainer = document.getElementById('flashContainer');
        flashContainer.innerHTML = '';
      });
    }
  </script>
</body>
</html>
